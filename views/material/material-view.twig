{% extends "layout-main.twig" %}

{% block title %}{{ material.title }}{% endblock %}
{% block page_title %}Materi: {{ material.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Konten Materi</h3>
            </div>
            <div class="card-body">
                {# Tampilkan konten berdasarkan tipe #}
                {% if material.type == 'PDF' %}
                    <embed src="{{ material.content }}" type="application/pdf" width="100%" height="600px" />
                {% elseif material.type == 'Image' %}
                    <img src="{{ material.content }}" class="img-fluid" alt="{{ material.title }}">
                {% elseif material.type == 'Link' %}
                    <p>Materi ini adalah sebuah link eksternal. Silakan klik tombol di bawah untuk membukanya di tab baru.</p>
                    <a href="{{ material.content }}" class="btn btn-lg btn-success" target="_blank">Buka Link</a>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Deskripsi</h3>
            </div>
            <div class="card-body">
                <p>{{ material.description }}</p>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Beri Feedback</h3>
            </div>
            <form id="feedback-form" method="post">
                <div class="card-body">
                    <div class="form-group">
                        <label for="feedback_text">Tulis tanggapan atau pertanyaan Anda di sini:</label>
                        <textarea class="form-control" id="feedback_text" name="feedback_text" rows="4" placeholder="Contoh: Materi ini sangat membantu, namun saya ada pertanyaan terkait poin B..." required></textarea>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-success">Kirim Feedback</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#feedback-form').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var formData = form.serialize();

        Swal.fire({
            title: 'Mengirim Feedback...',
            text: 'Mohon tunggu sebentar.',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        $.ajax({
            url: `/feedback/store/{{ material.id }}`, // Endpoint kita
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: response.message,
                }).then(() => {
                    // Kosongkan textarea dan disable tombol setelah berhasil
                    $('#feedback_text').val('');
                    form.find('button[type="submit"]').prop('disabled', true).text('Feedback Terkirim');
                });
            },
            error: function(xhr) {
                var errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Terjadi kesalahan.';
                Swal.fire({ icon: 'error', title: 'Gagal', text: errorMsg });
            }
        });
    });
});
</script>
{% endblock %}